name: ğŸš€ Deploy Singingbowlnepal Admin

on:
  push:
    branches:
      - main
      - master

env:
  SSH_HOST: "202.51.71.55"
  SSH_USER: "ubuntu"
  SSH_PORT: "22"
  PROJECT_PATH: "/var/www/admin"
  BRANCH: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” SSH + Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          envs: PROJECT_PATH,BRANCH

          script: |
            echo "ğŸš€ Starting Admin deployment"

            echo "ğŸ“ Switching to project directory"
            cd $PROJECT_PATH || { echo "âŒ Directory not found"; exit 1; }

            echo "ğŸ”„ Pulling latest code"
            git pull origin $BRANCH

            echo "ğŸ“¦ Installing dependencies (pnpm)"
            pnpm install --frozen-lockfile || pnpm install

            echo "ğŸ”¨ Building Admin"
            pnpm build

            echo "âš™ï¸ Restarting PM2"
            pm2 reload ecosystem.config.js --update-env || pm2 start ecosystem.config.js

            echo "âœ… Admin deployment complete"
